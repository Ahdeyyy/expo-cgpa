name: React Native CI/CD

on:
    push:
        branches: [main, master]
        paths-ignore:
            - "**.md"
            - "LICENSE"
            - "docs/**"
    pull_request:
        branches: [main, master]
    workflow_dispatch:
        inputs:
            buildType:
                type: choice
                description: "Build type to run"
                options:
                    - dev
                    - prod-apk
                    - prod-aab
                    - all

env:
    EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    # Keep NODE_OPTIONS as Metro bundler (run by EAS) still runs on Node under the hood
    NODE_OPTIONS: --openssl-legacy-provider

jobs:
    check-skip:
        runs-on: ubuntu-latest
        if: "!contains(github.event.head_commit.message, '[skip ci]')"
        steps:
            - name: Skip CI check
              run: echo "Proceeding with workflow"

    test:
        needs: check-skip
        runs-on: ubuntu-latest
        steps:
            - name: üèó Checkout repository
              uses: actions/checkout@v4

            - name: ü•Ø Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: üì¶ Install dependencies
              # --frozen-lockfile is the Bun equivalent of npm ci
              run: bun install --frozen-lockfile

    build-and-release:
        needs: test
        if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: üèó Checkout repository
              uses: actions/checkout@v4

            - name: ü•Ø Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: üì¶ Install dependencies
              run: |
                  bun install --frozen-lockfile
                  bun add -g eas-cli

            - name: üì± Setup EAS build cache
              uses: actions/cache@v3
              with:
                  path: ~/.eas-build-local
                  key: ${{ runner.os }}-eas-build-local-${{ hashFiles('**/package.json') }}
                  restore-keys: |
                      ${{ runner.os }}-eas-build-local-

            - name: üîÑ Verify EAS CLI installation
              run: |
                  echo "EAS CLI version:"
                  eas --version

            - name: üè∑Ô∏è Generate build information
              id: build-info
              run: |
                  # Using bun -e to execute the inline script
                  VERSION=$(bun -e "console.log(require('./app.json').expo.version)")
                  BUILD_NUMBER=$(date +%Y%m%d%H%M)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
                  # Generate changelog from commit messages since last tag
                  if git describe --tags --abbrev=0 > /dev/null 2>&1; then
                    LAST_TAG=$(git describe --tags --abbrev=0)
                    git log $LAST_TAG..HEAD --pretty=format:"- %s" > changelog.md
                  else
                    git log --pretty=format:"- %s" -n 10 > changelog.md
                  fi

            - name: üì± Build Development APK
              if: github.event.inputs.buildType == 'all' || github.event.inputs.buildType == 'dev' || github.event_name == 'push'
              run: |
                  # Build with increased memory limit
                  export NODE_OPTIONS="--openssl-legacy-provider --max_old_space_size=4096"
                  eas build --platform android --profile development --local --non-interactive --output=./expo-cgpa-${{steps.build-info.outputs.version}}-dev.apk
              env:
                  NODE_ENV: development

            - name: üì± Build Production APK
              if: github.event.inputs.buildType == 'all' || github.event.inputs.buildType == 'prod-apk' || github.event_name == 'push'
              run: |
                  export NODE_OPTIONS="--openssl-legacy-provider --max_old_space_size=4096"
                  eas build --platform android --profile preview --local --non-interactive --output=./expo-cgpa-${{steps.build-info.outputs.version}}-prod.apk
              env:
                  NODE_ENV: production

            - name: üì± Build Production AAB
              if: github.event.inputs.buildType == 'all' || github.event.inputs.buildType == 'prod-aab' || github.event_name == 'push'
              run: |
                  export NODE_OPTIONS="--openssl-legacy-provider --max_old_space_size=4096"
                  eas build --platform android --profile production --local --non-interactive --output=./expo-cgpa-${{steps.build-info.outputs.version}}-prod.aab
              env:
                  NODE_ENV: production

            - name: üìù Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  draft: true
                  name: "Release v${{ steps.build-info.outputs.version }}"
                  tag_name: "v${{ steps.build-info.outputs.version }}"
                  files: |
                      ./set-trip-${{steps.build-info.outputs.version}}-dev.apk
                      ./set-trip-${{steps.build-info.outputs.version}}-prod.apk
                      ./set-trip-${{steps.build-info.outputs.version}}-prod.aab
                  body_path: changelog.md
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: üì¶ Upload build artifacts to GitHub
              uses: actions/upload-artifact@v4
              with:
                  name: set-trip-${{ steps.build-info.outputs.version }}
                  path: |
                      ./set-trip-${{steps.build-info.outputs.version}}-dev.apk
                      ./set-trip-${{steps.build-info.outputs.version}}-prod.apk
                      ./set-trip-${{steps.build-info.outputs.version}}-prod.aab
                  retention-days: 7
